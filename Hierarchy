METHOD compute_EMPRESA.

*   IMPORTING
*     request     type rsrequest
*     datapackid  type rsdatapid
*     SOURCE_FIELDS-HIER_ID TYPE C LENGTH 000002
*    EXPORTING
*      RESULT type _ty_s_TG_1-/BIC/EMPRESA

    DATA:
      MONITOR_REC    TYPE rsmonitor.

*$*$ begin of routine - insert your code only below this line        *-*
    ... "insert your code here
*--  fill table "MONITOR" with values of structure "MONITOR_REC"
*-   to make monitor entries
    ... "to cancel the update process
*    raise exception type CX_RSROUT_ABORT.
    ... "to skip a record"
*    raise exception type CX_RSROUT_SKIP_RECORD.
    ... "to clear target fields
*    raise exception type CX_RSROUT_SKIP_VAL.

    CONCATENATE '0' SOURCE_FIELDS-hier_id INTO RESULT.

*
    CONSTANTS: lc_emp052  TYPE /bic/oiempresa VALUE '052',
               lc_emp080  TYPE /bic/oiempresa VALUE '080',
               lc_emp0002 TYPE /bic/oiempresa VALUE '0002'.

    IF RESULT EQ lc_emp052 OR RESULT EQ lc_emp080.

      RESULT = lc_emp0002.
    ENDIF.
*

*$*$ end of routine - insert your code only before this line         *-*
  ENDMETHOD. 

 
METHOD end_routine.
*=== Segments ===

    FIELD-SYMBOLS:
      <RESULT_FIELDS>    TYPE _ty_s_TG_1.

    DATA:
      MONITOR_REC     TYPE rstmonitor.

*$*$ begin of routine - insert your code only below this line        *-*
    ... "insert your code here
*--  fill table "MONITOR" with values of structure "MONITOR_REC"
*-   to make monitor entries
    ... "to cancel the update process
*    raise exception type CX_RSROUT_ABORT.

    CONSTANTS: lc_noarea TYPE char18 VALUE 'SIN_AREA'.

    DATA: lt_jer_final  TYPE SORTED TABLE OF _ty_s_tg_1
          WITH UNIQUE KEY
          /bic/empresa /bic/nivel /bic/nodo_char
          /bic/nod_sp_ch
          WITH NON-UNIQUE SORTED KEY k2 COMPONENTS /bic/nodo,
*          lt_area       TYPE HASHED TABLE OF /bic/pacdivi
* VN GDLD3169 - Jerarquia, limitar UNECO
*  20190606 - Se cambia tabla de datos maestros de division por
* la de dependientes del tiempo
          lt_area       TYPE HASHED TABLE OF /bic/qacdivi
          WITH UNIQUE KEY
          /bic/empresa /bic/acdivi dateto.

    DATA: ls_jer_final      TYPE _ty_s_tg_1,
          ls_jer_final_aux  TYPE _ty_s_tg_1,
          ls_jer_aux        TYPE _ty_s_tg_1,
          lv_nodo           TYPE rshienodid,
*          lv_node_char  TYPE char18,
* VN GDLD3169 - Jerarquia, limitar UNECO
*  20190606 - Se cambia tabla de datos maestros de division por
* la de dependientes del tiempo
*      ls_area           TYPE /bic/pacdivi,
      ls_area           TYPE /bic/qacdivi,
      lv_area           TYPE char18,
      lv_nodo_generico  TYPE rsshnodenamestr,
      lv_no_clear       TYPE flag,
      lv_insert         TYPE flag,
      lv_long           TYPE i,
      lv_empresa        TYPE /bic/oiempresa,
      lv_count_l2       TYPE i,
      lv_count_l3       TYPE i,
      lv_count_l4       TYPE i,
      lv_count_l5       TYPE i,
      lv_count_l6       TYPE i,
      lv_lines          TYPE i.

    DATA: lv_nodo_modif TYPE wdy_boolean.
*
    CONSTANTS: lc_emp001  TYPE /bic/oiempresa VALUE '001',
               lc_emp0002 TYPE /bic/oiempresa VALUE '0002',
*  VN GDLD14271
               lc_emp027  TYPE /bic/oiempresa VALUE '027',
*  (23/07/2020)
               lc_emp087  TYPE /bic/oiempresa VALUE '087',
               lc_emp093  TYPE /bic/oiempresa VALUE '093',
               lc_emp096  TYPE /bic/oiempresa VALUE '096',
               lc_emp063  TYPE /bic/oiempresa VALUE '063'.
*  (23/07/2020)
    DATA lt_result_package_aux TYPE _ty_t_tg_1.
    DATA lt_rp_aux TYPE _ty_t_tg_1. "jlc
*>>> VN INC000007558696 ini X08838MO
    DATA ls_jer_final_periv TYPE _ty_s_tg_1.
*<<< VN INC000007558696 fin X08838MO
*>>> 

    FIELD-SYMBOLS: <ls_tg_1>       TYPE _ty_s_tg_1.


*Ini AC
    DELETE RESULT_PACKAGE WHERE /bic/empresa NE lc_emp001.

    lt_rp_aux[] =  RESULT_PACKAGE[].
    DELETE lt_rp_aux WHERE /bic/empresa NE lc_emp001.
    LOOP AT lt_rp_aux   ASSIGNING FIELD-SYMBOL(<rp>).
      <rp>-/bic/empresa = lc_emp0002.
    ENDLOOP.
    APPEND LINES OF lt_rp_aux TO RESULT_PACKAGE.
*   Fin AC

*VN GDLD14271
    CLEAR lt_rp_aux[].
    lt_rp_aux[] =  RESULT_PACKAGE[].
    DELETE lt_rp_aux WHERE /bic/empresa NE lc_emp001.
    LOOP AT lt_rp_aux   ASSIGNING FIELD-SYMBOL(<rp2>).
      <rp2>-/bic/empresa = lc_emp027.
    ENDLOOP.
    APPEND LINES OF lt_rp_aux TO RESULT_PACKAGE.
*   Fin VN GDLD14271 

*  (23/07/2020)

* MEXICO
    CLEAR lt_rp_aux[].
    lt_rp_aux[] =  RESULT_PACKAGE[].
    DELETE lt_rp_aux WHERE /bic/empresa NE lc_emp001.
    LOOP AT lt_rp_aux   ASSIGNING FIELD-SYMBOL(<rp3>).
      <rp3>-/bic/empresa = lc_emp087.
    ENDLOOP.
    APPEND LINES OF lt_rp_aux TO RESULT_PACKAGE.
*
* GRECIA
    CLEAR lt_rp_aux[].
    lt_rp_aux[] =  RESULT_PACKAGE[].
    DELETE lt_rp_aux WHERE /bic/empresa NE lc_emp001.
    LOOP AT lt_rp_aux   ASSIGNING FIELD-SYMBOL(<rp4>).
      <rp4>-/bic/empresa = lc_emp093.
    ENDLOOP.
    APPEND LINES OF lt_rp_aux TO RESULT_PACKAGE.

* PORTUGAL
    CLEAR lt_rp_aux[].
    lt_rp_aux[] =  RESULT_PACKAGE[].
    DELETE lt_rp_aux WHERE /bic/empresa NE lc_emp001.
    LOOP AT lt_rp_aux   ASSIGNING FIELD-SYMBOL(<rp5>).
      <rp5>-/bic/empresa = lc_emp096.
    ENDLOOP.
    APPEND LINES OF lt_rp_aux TO RESULT_PACKAGE.

* POLONIA
    CLEAR lt_rp_aux[].
    lt_rp_aux[] =  RESULT_PACKAGE[].
    DELETE lt_rp_aux WHERE /bic/empresa NE lc_emp001.
    LOOP AT lt_rp_aux   ASSIGNING FIELD-SYMBOL(<rp6>).
      <rp6>-/bic/empresa = lc_emp063.
    ENDLOOP.
    APPEND LINES OF lt_rp_aux TO RESULT_PACKAGE.
* (23/07/2020)

* Se eliminan los nodos 07 y 08 de la jerarquía de UNECOS
    CLEAR lt_rp_aux[].
    lt_rp_aux[] =  RESULT_PACKAGE[].
    DELETE lt_rp_aux WHERE /bic/nivel = '05' OR /bic/nivel = '06'.
    RESULT_PACKAGE[] = lt_rp_aux[].

    SELECT /bic/empresa
          /bic/acdivi
          objvers
          dateto
          datefrom
          changed
          /bic/acarea
    FROM /bic/qacdivi
      INTO TABLE lt_area
      FOR ALL ENTRIES IN RESULT_PACKAGE
      WHERE /bic/empresa EQ RESULT_PACKAGE-/bic/empresa
      AND objvers EQ 'A'.


    SORT RESULT_PACKAGE BY /bic/empresa   ASCENDING
                           /bic/nivel     ASCENDING
                           /bic/nodo_char ASCENDING.


    LOOP AT RESULT_PACKAGE ASSIGNING <ls_tg_1>.

      IF lv_empresa NE <ls_tg_1>-/bic/empresa.

        CLEAR: lv_count_l3, lv_count_l4, lv_count_l5.

      ENDIF.

      IF <ls_tg_1>-/bic/nodo_char IS NOT INITIAL.

        SHIFT <ls_tg_1>-/bic/nodo_char RIGHT DELETING TRAILING space.
        TRANSLATE <ls_tg_1>-/bic/nodo_char USING ' 0'.

      ENDIF.

      IF <ls_tg_1>-/bic/nod_sp_ch IS NOT INITIAL.

        SHIFT <ls_tg_1>-/bic/nod_sp_ch RIGHT DELETING TRAILING space.
        TRANSLATE <ls_tg_1>-/bic/nod_sp_ch USING ' 0'.

      ENDIF.

      IF <ls_tg_1>-/bic/nivel EQ '1'.
        "Si el nivel es 1 es el  nodo superior del resto
        "Si no hay empresa empieza el recuento en 0
        IF lv_empresa IS INITIAL.
"Aquí se asigna valores con el que vamos a ir rellenando los nodos
          lv_count_l2 = 2.
          lv_count_l3 = lv_count_l2.
          "Cada nueva empresa se añade 10000 para diferenciar
        ELSE.
          lv_count_l2 = lv_count_l2 + 10000.
          lv_count_l3 = lv_count_l2.
        ENDIF.
"Si el nivel es 1 se añade 1 ya que el primer nivel será el grupo
        "completo
        ADD 1 TO <ls_tg_1>-/bic/nivel.

      ELSE.
        "Sino se añaden dos nivel para crear los áreas en el nivel 3
        ADD 2 TO <ls_tg_1>-/bic/nivel.

      ENDIF.

      "Si el registro es nivel 2 no tiene padres
      IF <ls_tg_1>-/bic/nivel EQ '2'.

        lv_empresa = <ls_tg_1>-/bic/empresa.

        MOVE-CORRESPONDING <ls_tg_1> TO ls_jer_final.
        "Para el primer nodo se insertan valores constantes
        "salvo el nodo que cambiará con la empresa
        ls_jer_final-/bic/nod_sp_ch = '000000000000000001'.
        ls_jer_final-/bic/nodo = lv_count_l2.
        ls_jer_final-/bic/nodo_sup = '1'.

        INSERT ls_jer_final INTO TABLE lt_jer_final.

        CLEAR ls_jer_final.

        "Si el registro es nivel 4
      ELSEIF <ls_tg_1>-/bic/nivel EQ '4'.

          "Si no los hay se lee la tabla de divisiones para generarlas
          READ TABLE lt_area INTO ls_area
          WITH KEY /bic/empresa = <ls_tg_1>-/bic/empresa
                   /bic/acdivi  = <ls_tg_1>-/bic/nodo_char+16(2)
                   dateto       = '99991231'.
          "Se genera el nivel 3 con las divisiones
          IF sy-subrc EQ 0.
            "Se suma uno a la empresa para crear cada división
            lv_count_l3 = lv_count_l3 + 1.
            "Si el área está vacía se pone la constante sin área
            IF ls_area-/bic/acarea IS INITIAL.

              lv_area = lc_noarea.
              "Si no se deja el área
            ELSE.

              lv_area = ls_area-/bic/acarea.

            ENDIF.
"Se insertan los registros en el workarea para generar el nivel 3 con
            "los áreas
            ls_jer_final-/bic/empresa = <ls_tg_1>-/bic/empresa.
            ls_jer_final-/bic/nivel = '3'.
            ls_jer_final-/bic/nodo_char = lv_area.
            ls_jer_final-/bic/nod_sp_ch = <ls_tg_1>-/bic/nod_sp_ch.
            ls_jer_final-/bic/nodo = lv_count_l3.
            ls_jer_final-/bic/nodo_sup = lv_count_l2.

            INSERT ls_jer_final INTO TABLE lt_jer_final.

            CLEAR ls_jer_final.

            SELECT *
              FROM /bic/qacdivi
              WHERE /bic/empresa = @<ls_tg_1>-/bic/empresa
              AND dateto         = '99991231'
              AND objvers        = 'A'
              INTO TABLE @DATA(lt_area_emp).
"Se recogen el número de divisiones que tiene la empresa para que
            "los nodos del nivel 4 no se solapen con los del nivel 3
            DESCRIBE TABLE lt_area_emp LINES lv_lines.
"Se suma el valor del nivel 3 más las filas y se genera el valor nivel 4
            lv_count_l4 = lv_count_l3 + lv_lines.

            READ TABLE lt_jer_final INTO ls_jer_final_aux WITH KEY
                      /bic/empresa = <ls_tg_1>-/bic/empresa
                      /bic/nivel = '3'
                      /bic/nodo_char = lv_area.
"Si el nodo padre de este área está cargado (si existe padre)
            IF sy-subrc EQ 0.
"Pasamos los valores del registro (los de nivel 4) a un workarea
              MOVE-CORRESPONDING <ls_tg_1> TO ls_jer_final.
              "Asignamos el área al nodo padre
              ls_jer_final-/bic/nod_sp_ch = lv_area.
              ls_jer_final-/bic/nodo = lv_count_l4.
"Se inserta el nodo padre que está en workarea ls_jer_final_aux
              ls_jer_final-/bic/nodo_sup = ls_jer_final_aux-/bic/nodo.

              INSERT ls_jer_final INTO TABLE lt_jer_final.
              CLEAR ls_jer_final.

            ELSE.
              "Si no hay nodo padre
              MOVE-CORRESPONDING <ls_tg_1> TO ls_jer_final.

              ls_jer_final-/bic/nod_sp_ch = lv_area.
              ls_jer_final-/bic/nodo = lv_count_l4.
              "Inserta el valor de nivel 3 como nodo padre
              ls_jer_final-/bic/nodo_sup = lv_count_l3.

              INSERT ls_jer_final INTO TABLE lt_jer_final.
              CLEAR ls_jer_final.

            ENDIF.

          ENDIF.

        lv_count_l5 = lv_count_l4.

      ELSEIF <ls_tg_1>-/bic/nivel EQ '5'.

          lv_count_l5 = lv_count_l5 + 1.

          READ TABLE lt_jer_final INTO ls_jer_final_aux WITH KEY
                      /bic/empresa = <ls_tg_1>-/bic/empresa
                      /bic/nivel = '4'
                      /bic/nodo_char = <ls_tg_1>-/bic/nod_sp_ch.

          IF sy-subrc EQ 0.

            MOVE-CORRESPONDING <ls_tg_1> TO ls_jer_final.

            ls_jer_final-/bic/nodo = lv_count_l5.
            ls_jer_final-/bic/nodo_sup = ls_jer_final_aux-/bic/nodo.

            INSERT ls_jer_final INTO TABLE lt_jer_final.

          ENDIF.

        lv_count_l6 = lv_count_l5.


      ELSEIF <ls_tg_1>-/bic/nivel EQ '6'.

          lv_count_l6 = lv_count_l6 + 1.

          READ TABLE lt_jer_final INTO ls_jer_final_aux WITH KEY
                      /bic/empresa = <ls_tg_1>-/bic/empresa
                      /bic/nivel = '5'
                      /bic/nodo_char = <ls_tg_1>-/bic/nod_sp_ch.

          IF sy-subrc EQ 0.

            MOVE-CORRESPONDING <ls_tg_1> TO ls_jer_final.

            ls_jer_final-/bic/nodo = lv_count_l6.
            ls_jer_final-/bic/nodo_sup = ls_jer_final_aux-/bic/nodo.

            INSERT ls_jer_final INTO TABLE lt_jer_final.

          ENDIF.

      ENDIF.

      lv_empresa = <ls_tg_1>-/bic/empresa.

    ENDLOOP.

    RESULT_PACKAGE[] = lt_jer_final[].

*$*$ end of routine - insert your code only before this line         *-*
  ENDMETHOD.    
